#!/bin/bash

# Build javascript version of antimony library using Emscripten.
# Confirm:
# 1. $LIBANTIMONYJS_DIR is defined. This is the build directory.
# 2. Make sure Emscripten is in $PATH, check with 'emmcc -v'
#
# - expat lib source code is in $LIBANTIMONYJS_DIR/expat
# - libSBML source code is in $LIBANTIMONYJS_DIR/libsbml
# - antimony source code is in $LIBANTIMONYJS_DIR/antimony
# - Final code will be in $LIBANTIMONYJS_DIR/install

ANT_VERS="2.14"
SBML_VERS="5.20.0"
rm -fr $LIBANTIMONYJS_DIR
mkdir $LIBANTIMONYJS_DIR
cd $LIBANTIMONYJS_DIR
# location of built libraries:
mkdir install

# Build expat lib:
echo "Building Expat library:"
# grab expat 2.2.10:
wget https://github.com/libexpat/libexpat/releases/download/R_2_2_10/expat-2.2.10.tar.bz2
tar -xf expat-2.2.10.tar.bz2
mv expat-2.2.10 expat
cd expat
rm -fr build
mkdir build
cd build
emcmake cmake .. -DCMAKE_INSTALL_PREFIX=$LIBANTIMONYJS_DIR/install/expat
emmake make
emmake make install

# Now build libSBML:
cd $LIBANTIMONYJS_DIR
echo "Building libSBML:"
echo "wget https://github.com/sbmlteam/libsbml/archive/refs/tags/v$SBML_VERS.zip"
wget https://github.com/sbmlteam/libsbml/archive/refs/tags/v$SBML_VERS.zip
unzip v$SBML_VERS.zip
mv libsbml-$SBML_VERS libsbml
cd $LIBANTIMONYJS_DIR/libsbml
rm -fr build
mkdir build
cd build
emcmake cmake .. -DCMAKE_INSTALL_PREFIX=$LIBANTIMONYJS_DIR/install/sbml -DCMAKE_BUILD_TYPE=Release -DWITH_CPP_NAMESPACE=ON -DWITH_EXPAT=ON -DWITH_LIBXML=OFF -DLIBSBML_SKIP_SHARED_LIBRARY=ON -DENABLE_ARRAYS=ON -DENABLE_COMP=ON -DENABLE_DISTRIB=ON -DENABLE_FBC=ON -DENABLE_GROUPS=ON -DENABLE_MULTI=ON -DENABLE_QUAL=ON -DWITH_STABLE_PACKAGES=ON -DWITH_SWIG=OFF -DEXPAT_INCLUDE_DIR=$LIBANTIMONYJS_DIR/install/expat/include -DEXPAT_LIBRARY=$LIBANTIMONYJS_DIR/install/expat/lib/libexpat.a
emmake make
emmake make install

# Build libAntimony:
cd $LIBANTIMONYJS_DIR
echo "Building Antimony library:"
echo "wget https://github.com/sys-bio/antimony/archive/refs/tags/v$ANT_VERS.zip"
wget https://github.com/sys-bio/antimony/archive/refs/tags/v$ANT_VERS.zip
unzip v$ANT_VERS.zip
mv antimony-$ANT_VERS/ antimony
cd $LIBANTIMONYJS_DIR/antimony
rm -fr build
mkdir build
cd build
emcmake cmake .. -DCMAKE_INSTALL_PREFIX=$LIBANTIMONYJS_DIR/install/antimony -DCMAKE_BUILD_TYPE=Release -DEXPAT_LIBRARY=$LIBANTIMONYJS_DIR/install/expat/lib/libexpat.a -DLIBSBML_INCLUDE_DIR=$LIBANTIMONYJS_DIR/install/sbml/include -DLIBSBML_INSTALL_DIR=$LIBANTIMONYJS_DIR/install/sbml -DLIBSBML_LIBRARY=$LIBANTIMONYJS_DIR/install/sbml/lib/libsbml-static.a -DWITH_CELLML=OFF -DWITH_CHECK=OFF -DWITH_COMP_SBML=ON -DWITH_LIBSBML_COMPRESSION=OFF -DWITH_LIBSBML_EXPAT=ON -DWITH_LIBSBML_LIBXML=OFF -DWITH_LIBSBML_XERCES=OFF -DWITH_PYTHON=OFF -DWITH_QTANTIMONY=OFF -DWITH_SBML=ON -DWITH_STATIC_SBML=ON -DWITH_SWIG=OFF
emmake make
emmake make install

# Generate the javascript and associated .wasm file:
echo "Generate antimony javascript and wasm files..."
cd $LIBANTIMONYJS_DIR/install
emcc -Oz -sDISABLE_EXCEPTION_CATCHING=0 -sMODULARIZE=1 -sSINGLE_FILE=1 -sEXPORT_NAME=libantimony -sALLOW_MEMORY_GROWTH=1 -I$LIBANTIMONYJS_DIR/install/antimony/include -I$LIBANTIMONYJS_DIR/install/sbml/include -I$LIBANTIMONYJS_DIR/install/expat/include $LIBANTIMONYJS_DIR/install/antimony/lib/libantimony.a $LIBANTIMONYJS_DIR/install/sbml/lib/libsbml-static.a $LIBANTIMONYJS_DIR/install/expat/lib/libexpat.a -o libantimony.js -sEXPORTED_FUNCTIONS=_loadString,_loadAntimonyString,_loadSBMLString,_clearPreviousLoads,_getAntimonyString,_getSBMLString,_getCompSBMLString,_getLastError,_getWarnings,_getSBMLInfoMessages,_getSBMLWarnings,_freeAll,_malloc,_free -sEXPORTED_RUNTIME_METHODS=ccall,cwrap,allocateUTF8,UTF8ToString
 



