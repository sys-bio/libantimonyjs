<html lang="en">
  <head>
  <script src="libantimony.js" type="text/javascript"></script>
  <script src="libantimony.wasm" type="application/wasm"> </script>  
  </head>
	
<body>

<!-- Test Antimony javascript library -->


<script type="text/javascript">
var antString = "model example1; S1 -> S2; k1*S ; S1 = 550; S2 = 0;  k1 = 0.1; end"
var antCode;
var sbmlCode;
var sbmlResult = 'None';
var antResult = 'None';

var loadAntimonyString; // libantimony function
var loadString;			// 		"
var loadSBMLString;		//		"
var getSBMLString;		//		"
var getAntimonyString;	//		"
var getCompSBMLString;	//		"
var clearPreviousLoads; //		"
var getLastError;		//		"
var getWarnings;		//		"
var getSBMLInfoMessages;//		"
var getSBMLWarnings;	//		"
var freeAll;			//		"
var jsFree;     		// emscripten function
//var jsMalloc;	   		//      " Not needed
var jsAllocateUTF8;		//		"
var jsUTF8ToString; 	//		"

// Load library functions (asynchronous call):
try {
 libantimony().then((libantimony) => {
 //	Format: libantimony.cwrap( function name, return type, input param array of types).
 loadString = libantimony.cwrap('loadString', 'number', ['number']);
 loadAntimonyString = libantimony.cwrap('loadAntimonyString', 'number', ['number']);
 loadSBMLString = libantimony.cwrap('loadSBMLString', 'number', ['number']);
 getSBMLString = libantimony.cwrap('getSBMLString', 'string', ['null']);
 getAntimonyString = libantimony.cwrap('getAntimonyString', 'string', ['null']);
 getCompSBMLString = libantimony.cwrap('getCompSBMLString', 'string', ['string']); 
 clearPreviousLoads = libantimony.cwrap('clearPreviousLoads', 'null', ['null']);
 getLastError = libantimony.cwrap('getLastError', 'string', ['null']);
 getWarnings = libantimony.cwrap('getWarnings', 'string', ['null']);
 getSBMLInfoMessages = libantimony.cwrap('getSBMLInfoMessages', 'string', ['string']);
 getSBMLWarnings = libantimony.cwrap('getSBMLWarnings', 'string', ['string']);
 freeAll = libantimony.cwrap('freeAll', 'null', ['null']);
 // Emscripten funcs (direct calls):
 jsFree = (strPtr) => libantimony._free(strPtr); 
 jsAllocateUTF8 = (newStr) =>  libantimony.allocateUTF8(newStr); 
 // Do not need?:
 jsUTF8ToString = (strPtr) => libantimony.UTF8ToString(strPtr);
 //jsMalloc = (strLenPlus1) => libantimony._malloc(strLenPlus1); // Not needed, use jsAllocateUTF8 to reserve space on Emscripten Heap for string.
 });
}
catch(err) {
  console.log('Load libantimony error: ', err);
}
// Test functionality:
function runAntimonyCheck() {
  var intResult = loadString( jsAllocateUTF8(antString) ); // TEST loadString()
  var antResult;
   console.log('** TEST: loadString():');
  if(intResult < 0) {
    console.log('loadString() returned error:' ,intResult);
    console.log(getLastError());
  }
  sbmlResult = getSBMLString();
  console.log('Antimony model: ', antString);
  console.log('load ant return int:' ,intResult);
  console.log('SBML' ,sbmlResult);
  clearPreviousLoads();
  
  sbmlResult = 'none';		// TEST loadAntimonyString()
  intResult = loadAntimonyString( jsAllocateUTF8(antString) );
  sbmlResult = getSBMLString();
  console.log('** TEST: loadAntimonyString(), return int:' ,intResult);
  console.log('SBML again: ' ,sbmlResult);
  
  clearPreviousLoads();		// TEST loadSBMLString()
  intResult = loadSBMLString( jsAllocateUTF8(sbmlResult) );
  antResult = getAntimonyString();
  console.log('** TEST: loadSBMLString(), return int:' ,intResult);
  console.log('Antimony string: ' ,antResult);
  console.log('getWarnings: ', getWarnings());
  
  clearPreviousLoads();		// TEST getLastError(), SBML error
  var errSBMLStr = sbmlResult.replace('id="S1"', 'id="S5"');
  intResult = loadSBMLString( jsAllocateUTF8(errSBMLStr) );
  console.log('** TEST: load bad SBML model, return int:' ,intResult);
  console.log('bad SBML: getLastError(): ', getLastError());
  console.log('bad SBML: getSBMLInfoMessages(): ', getSBMLInfoMessages());// none expected
  console.log('bad SBML: getSBMLWarnings(): ', getSBMLWarnings('example1')); // none expected
  
  clearPreviousLoads();		// TEST getLastError(), Antimony error
  var errAntStr = "model example1; S1 -> S2; k1*S*S5 S1 > S5*550; S2 = 0;  k1 = 0.1; end";
  intResult = loadAntimonyString( jsAllocateUTF8(errAntStr) );
  console.log('** TEST: load Bad Antimony model, return int:' ,intResult);
  console.log('Bad Antimony: getLastError(): ', getLastError()); // none expected
  console.log('Bad Antimony: getSBMLInfoMessages(): ', getSBMLInfoMessages());// none expected
  console.log('Bad Antimony: getSBMLWarnings(): ', getSBMLWarnings('example1')); 
  
  clearPreviousLoads();		// TEST getSBMLWarnings(), Antimony error
  var errAntStr = "model example1; S1 -> S2; k1*S*S5 ; S1 > S5*550; S2 = 0;  k1 = 0.1; end";
  intResult = loadAntimonyString( jsAllocateUTF8(errAntStr) );
  console.log('** TEST: load Warnings Antimony model, return int:' ,intResult);
  console.log('Warnings Antimony: getLastError(): ', getLastError()); // none expected
  console.log(' Warnings Antimony: getSBMLInfoMessages(): ', getSBMLInfoMessages());// none expected
  console.log(' Warnings Antimony: getSBMLWarnings(): ', getSBMLWarnings('example1')); 
  return sbmlResult;
}
</script>

<script type="text/javascript">

function processAntimony() {
 antCode = document.getElementById("antimonycode").value;
 clearPreviousLoads();
 //console.log("*** Antimony code: ",antCode);
 var ptrAntCode = jsAllocateUTF8(antCode);
 var load_int= loadAntimonyString(ptrAntCode);
 console.log("processAntimony: int returned: ", load_int);
 if (load_int > 0) {
   sbmlResult = getSBMLString(); 
   document.getElementById("sbmlcode").value = sbmlResult;
   document.getElementById("procSBMLBtn").disabled = false;
 
 }
 else { 
   var errStr = getLastError();
   window.alert(errStr); }
 jsFree(ptrAntCode);
}

function processSBML() {
 sbmlCode = document.getElementById("sbmlcode").value;
 clearPreviousLoads();
 var ptrSBMLCode = jsAllocateUTF8(sbmlCode);
 var load_int= loadSBMLString(ptrSBMLCode);
 console.log("processSBML: int returned: ", load_int);
 if (load_int > 0) {
   antResult = getAntimonyString(); 
   document.getElementById("antimonycode").value = antResult;
   document.getElementById("procAntimonyBtn").disabled = false;
 }
 else { 
   var errStr = getLastError();
   window.alert(errStr); 
   }
 jsFree(ptrSBMLCode);
 
}

 function processFile(fileStr) {
 //console.log('Loaded Model str: ', fileStr);
 try {
     var ptrFileStr = jsAllocateUTF8(fileStr);
     if(loadAntimonyString(ptrFileStr) > 0) {
	 document.getElementById("antimonycode").value = fileStr; 
	 document.getElementById("procSBMLBtn").disabled = true;
	 document.getElementById("sbmlcode").value = "[SBML code here.]";} 
	 else if (loadSBMLString(ptrFileStr) > 0){
	   document.getElementById("sbmlcode").value = fileStr; 
	   document.getElementById("procAntimonyBtn").disabled = true;
	   document.getElementById("antimonycode").value = "[Antimony code here.]";
	   }
	  else {
	    var errStr = getLastError();
		window.alert(errStr);
		clearPreviousLoads();
		}
	}
	catch(err) {
	  console.log('processing file error: :', err);
	  window.alert(err);
	}
	jsFree(ptrFileStr);
 }

</script>
<p>
<strong>Test the libAntimony functions from within JavaScript. </strong>
</p>
<p>
Convert Antimony to SBML or vice-versa:
<ul>

<li>Load an Antimony or SBML file to be converted: </li>
 <input type="file" name="inputfile" id="inputfile">
    <br> 
    <script type="text/javascript">
        document.getElementById('inputfile')
            .addEventListener('change', function() {
            var fr=new FileReader();
            fr.onload=function(){
				var modelString = fr.result;
				processFile(modelString);
            }         
            fr.readAsText(this.files[0]);
        })
    </script>

<script>
//?document.write(antString);
</script>
</p>
<p>
<p>
<li><label>Or type or paste in your Antimony:</label></li></br>
<textarea id="antimonycode" rows="20" cols="80" maxlength="100000">
[Antimony code here.]
</textarea>
</p>
<p>
<input type = "button" id="procAntimonyBtn" onclick = "processAntimony()" value = "Convert Antimony to SBML">
</p>
<p>
<input type = "button" id="procSBMLBtn" onclick = "processSBML()" value = "Convert SBML to Antimony">
</p>
<p>
<li><label>Or SBML:</label></li></br>
<textarea id="sbmlcode" rows="20" cols="80" maxlength="100000">
[SBML code here.]
</textarea>
</p>
</br>
</p>
<li><button onclick="runAntimonyCheck()">Test library, View in console.</button></li>
</br>
</ul>

</p>

</body>


</html>
